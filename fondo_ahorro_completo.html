
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Fondo Ahorro - OCR + Calculadora + Historial</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #eef2f3;
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }
    h1, h2 {
      color: #004d40;
    }
    section {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    input[type="number"], input[type="file"] {
      padding: 10px;
      margin: 10px 0;
      width: 100%;
    }
    .label { font-weight: bold; color: #00695c; }
    .result, table { margin-top: 20px; width: 100%; border-collapse: collapse; }
    table, th, td { border: 1px solid #ccc; }
    th, td { padding: 10px; text-align: center; }
    button {
      padding: 10px 20px;
      background-color: #004d40;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover {
      background-color: #00695c;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
</head>
<body>
  <h1>Fondo Ahorro - OCR + Calculadora + Historial</h1>

  <section>
    <h2>1. Subir n√≥mina</h2>
    <input type="file" id="upload" accept="image/*,application/pdf" />
    <progress id="progress" value="0" max="1" style="width: 100%; display: none;"></progress>
    <div id="ocrResult" style="margin-top:10px;"></div>
  </section>

  <section>
    <h2>2. Calculadora precargada</h2>
    <label for="sueldo">Sueldo mensual base (MXN):</label>
    <input type="number" id="sueldo" value="0" step="100">
    <label for="aporte">Porcentaje a aportar (%): <span id="porcentaje">18.2</span>%</label>
    <input type="range" id="aporte" min="0" max="18.2" value="18.2" step="0.1">
    <div class="result">
      <p><span class="label">Aporte anual del trabajador:</span> <span id="aporteTrabajador">$0.00</span></p>
      <p><span class="label">Aporte anual de CFE:</span> <span id="aporteCFE">$0.00</span></p>
      <p><span class="label">Total fondo acumulado:</span> <span id="totalFondo">$0.00</span></p>
    </div>
    <button onclick="guardarHistorial()">Guardar en historial</button>
  </section>

  <section>
    <h2>3. Historial</h2>
    <table id="tablaHistorial">
      <thead>
        <tr><th>Fecha</th><th>Sueldo</th><th>% Aportado</th><th>Total Fondo</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <script>
    const sueldoInput = document.getElementById('sueldo');
    const aporteInput = document.getElementById('aporte');
    const porcentajeSpan = document.getElementById('porcentaje');
    const aporteTrabajadorSpan = document.getElementById('aporteTrabajador');
    const aporteCFESpan = document.getElementById('aporteCFE');
    const totalFondoSpan = document.getElementById('totalFondo');

    function calcular() {
      const sueldo = parseFloat(sueldoInput.value);
      const porcentaje = parseFloat(aporteInput.value);
      const aporteMensual = sueldo * (porcentaje / 100);
      const aporteAnual = aporteMensual * 12;
      const total = aporteAnual * 2;

      porcentajeSpan.textContent = porcentaje.toFixed(1);
      aporteTrabajadorSpan.textContent = '$' + aporteAnual.toFixed(2);
      aporteCFESpan.textContent = '$' + aporteAnual.toFixed(2);
      totalFondoSpan.textContent = '$' + total.toFixed(2);
    }

    sueldoInput.addEventListener('input', calcular);
    aporteInput.addEventListener('input', calcular);
    calcular();

    function guardarHistorial() {
      const sueldo = parseFloat(sueldoInput.value);
      const porcentaje = parseFloat(aporteInput.value);
      const total = parseFloat(totalFondoSpan.textContent.replace('$',''));

      const entry = {
        fecha: new Date().toLocaleDateString(),
        sueldo,
        porcentaje,
        total
      };

      let historial = JSON.parse(localStorage.getItem('historialFondo')) || [];
      historial.push(entry);
      localStorage.setItem('historialFondo', JSON.stringify(historial));
      renderHistorial();
    }

    function renderHistorial() {
      const tbody = document.querySelector('#tablaHistorial tbody');
      tbody.innerHTML = '';
      const historial = JSON.parse(localStorage.getItem('historialFondo')) || [];
      historial.forEach(e => {
        tbody.innerHTML += `
          <tr>
            <td>${e.fecha}</td>
            <td>$${e.sueldo.toFixed(2)}</td>
            <td>${e.porcentaje}%</td>
            <td>$${e.total.toFixed(2)}</td>
          </tr>
        `;
      });
    }

    renderHistorial();

    // OCR
    const upload = document.getElementById('upload');
    const progress = document.getElementById('progress');
    const ocrResult = document.getElementById('ocrResult');

    upload.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async () => {
        const img = new Image();
        img.src = reader.result;

        img.onload = async () => {
          progress.style.display = 'block';
          const result = await Tesseract.recognize(img, 'spa', {
            logger: m => {
              if (m.status === 'recognizing text') {
                progress.value = m.progress;
              }
            }
          });
          progress.style.display = 'none';

          const text = result.data.text;
          ocrResult.textContent = text;

          const sueldoMatch = text.match(/SALARIO\s+10\s+(\$?\d+[.,]\d{2})/i);
          if (sueldoMatch) {
            const value = parseFloat(sueldoMatch[1].replace('$','').replace(',',''));
            sueldoInput.value = value * 2;
            calcular();
          }
        };
      };
      reader.readAsDataURL(file);
    });
  </script>
</body>
</html>
